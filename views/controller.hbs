<script type="text/javascript" src="http://cdn.robotwebtools.org/EaselJS/current/easeljs.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>

<script type="text/javascript" src="../js/roslib.min.js"></script>
<script type="text/javascript" src="../js/ros2d.js"></script>
<script type="text/javascript" src="../js/nav2d.js"></script>

<script type="text/javascript">
  
  /**
   * Setup all GUI elements when the page is loaded.
   */
  function init() {
    var button = document.getElementById('button');
    var buttonDiv = document.getElementById('buttonDiv');
    buttonDiv.style.display = 'none';

    // Connect to ROS.
    var ros = new ROSLIB.Ros({
      url : 'ws://172.18.6.38:9090'
    });

    // Create the main viewer.
    var viewer = new ROS2D.Viewer({
      divID : 'nav',
      width : 450,
      height : 450
    });

    
    // Subscribing to a Topic for noticfication
    // ----------------------

    var listener = new ROSLIB.Topic({
        ros : ros,
        //topic name
        name : '/confirm',
        messageType : 'std_msgs/String'
    });

    listener.subscribe(function(message) {
        console.log('Received message on ' + listener.name + ': ' + message.data);
        var element = document.getElementById("dstatus");
        if(message.data == "confirm"){
            console.log("123");
            element.innerHTML= "Delivery status: " + message.data;
            document.getElementById("button-wn-show-preset").click();
        }
        else{
            console.log("456");
            element.innerHTML= "Delivery status: Not finish" ;
        }
        listener.unsubscribe();
    });


    // Setup the nav client with Orientation
    var nav = NAV2D.OccupancyGridClientNav({
      ros : ros,   
      rootObject : viewer.scene,
      viewer : viewer,
      serverName : '/move_base',
      topic : '/map',
      actionName : '/move_base/goal',
      withOrientation : true,
      continuous : true
    });
    
    //set the path 
    var listener = new ROSLIB.Topic({
      ros : ros,
      name : '/move_base/NavfnROS/plan',
      messageType : 'nav_msgs/Path'
    });

    listener.subscribe(function(pose){
      var setColor = createjs.Graphics.getRGB(240, 0, 0);
      console.log('Recevie data '+ listener.name+' :'+ pose.poses[0].pose.position.x);
      var path = new ROS2D.PathShape({
          path: pose,
          strokeSize: 0.03,
          strokeColor: setColor
       });
    //add the object into viewer
    viewer.addObject(path);
    // viewer.addObject(navArrow);
    });
  }
</script>

<!-- Page Heading/Breadcrumbs -->
<div class="row">
      <div class="col-lg-12">
          <h1 class="page-header">Controller
              <small>Robot Controller</small>
          </h1>
          <ol class="breadcrumb">
              <li><a href="/">Home</a>
              </li>
              <li class="active">Controller</li>
          </ol>
      </div>
</div>

<div class="row">
      <div class="col-md-6">
          <h2>Robot Navigation</h2><small>Clicking at the goal position and pointing into the desired direction</small>
          <div id="buttonDiv">
          <button id="button" onclick="init()">Click to open the map</button>
          </div>
          {{!--<img class="img-responsive" src="../img/dilidili.jpg" alt="">--}}
          <div id="nav"></div>
      </div>
      <div class="col-md-6">
                <h2>Press any key to control robot</h2>
                <div class="btn-group btn-group-justified">
                    <a href="#" class="btn btn-default" onclick="leftUp()"><div><i class="fa fa-undo" aria-hidden="true"></i></div> Left Up</a>
                    <a href="#" class="btn btn-default" onclick="up()"><div><i class="fa fa-arrow-up" aria-hidden="true"></i></div>Up</a>
                    <a href="#" class="btn btn-default" onclick="rightUp()"><div><i class="fa fa-repeat" aria-hidden="true"></i></div>Right Up</a>
                </div>

                <div class="btn-group btn-group-justified">
                    <style>
                    div#myDiv {
                        -ms-transform: rotate(180deg); /* IE 9 */
                        -webkit-transform: rotate(180deg); /* Safari */
                        transform: rotate(180deg); /* Standard syntax */
                    }
                    </style>
                        <a href="#" class="btn btn-default" onclick="leftDown()"><div id ="myDiv"><i class="fa fa-undo" aria-hidden="true"> </i></div>Left Down</a>
                        <a href="#" class="btn btn-default" onclick="down()"><div><i class="fa fa-arrow-down" aria-hidden="true"></i></div>Down</a>
                        <a href="#" class="btn btn-default" onclick="rightDown()"><div id ="myDiv"><i class="fa fa-repeat" aria-hidden="true"> </i></div>Right Down</a>
                    </div>
                <div class="btn-group btn-group-justified">
                    <a href="#" class="btn btn-default" onclick="stop()"><div><i class="fa fa-stop" aria-hidden="true"></i></div>Stop</a>
                </div>    
      </div>
      <div class="col-md-6">
         <h2>Store the Goal</h2>
         <form id="goal" name="goal" method="POST" enctype="multipart/form-data">
         <div name="goal" id="goalDiv">
            
         </div>
         {{!--<p id="x">Clicked Goal Poistion X: </p>--}}
         {{!--<p id="y">Clicked Goal Poistion Y: </p>--}}
         <button id="submit" type="submit" class="btn btn-primary" style="display: none;">Submit</button>
         </form>
      </div>
</div>

<script>
  function up() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 76
    });
    var twist2 = new ROSLIB.Message({
      data : 203
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
  function down() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 52
    });
    var twist2 = new ROSLIB.Message({
      data : 180
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
  function rightUp() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 76
    });
    var twist2 = new ROSLIB.Message({
      data : 210
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
  function leftUp() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 85
    });
    var twist2 = new ROSLIB.Message({
      data : 203
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
  function rightDown() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 52
    });
    var twist2 = new ROSLIB.Message({
      data : 210
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
  function leftDown() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 85
    });
    var twist2 = new ROSLIB.Message({
      data : 180
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
  function stop() {
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/robot_command',
      messageType : 'std_msgs/UInt8'
    });
    var twist1 = new ROSLIB.Message({
      data : 0
    });
    var twist2 = new ROSLIB.Message({
      data : 0
    });
    cmdVel.publish(twist1);
    cmdVel.publish(twist2);
  }
</script>